name: KBO ìë™ ë°ì´í„° í¬ë¡¤ë§ ë° ì—…ë°ì´íŠ¸

on:
  schedule:
    # í•œêµ­ì‹œê°„ ê¸°ì¤€: ì˜¤í›„ 6ì‹œ, ì˜¤í›„ 10ì‹œ, ë°¤ 12ì‹œ (UTC +9ì‹œê°„ ì°¨ì´)
    - cron: '0 9 * * *'   # UTC 09:00 = KST 18:00 (ì˜¤í›„ 6ì‹œ)
    - cron: '0 13 * * *'  # UTC 13:00 = KST 22:00 (ì˜¤í›„ 10ì‹œ)
    - cron: '0 15 * * *'  # UTC 15:00 = KST 00:00 (ë°¤ 12ì‹œ)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      skip_crawling:
        description: 'í¬ë¡¤ë§ ê±´ë„ˆë›°ê¸° (ë°ì´í„° ì²˜ë¦¬ë§Œ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# ê¶Œí•œ ì„¤ì • (Pages ë°°í¬ í¬í•¨)
permissions:
  contents: write    # ì½”ë“œ ì²´í¬ì•„ì›ƒ ë° ì»¤ë°‹
  pages: write       # GitHub Pages ë°°í¬
  id-token: write    # OIDC í† í° (Pages ë°°í¬ìš©)

jobs:
  kbo-auto-update:
    runs-on: ubuntu-latest
    
    # GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ í™˜ê²½ ì„¤ì •
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Node.js í™˜ê²½ ì„¤ì •
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # 3. Python í™˜ê²½ ì„¤ì •
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    # 4. Chrome ë¸Œë¼ìš°ì € ì„¤ì¹˜ (í¬ë¡¤ë§ìš©)
    - name: ğŸŒ Chrome ë¸Œë¼ìš°ì € ì„¤ì¹˜
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable

    # 5. í™˜ê²½ë³€ìˆ˜ ì„¤ì •
    - name: âš™ï¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        echo "KBO_PROJECT_ROOT=${{ github.workspace }}" >> $GITHUB_ENV
        echo "NODE_ENV=production" >> $GITHUB_ENV
        echo "KBO_LOG_LEVEL=INFO" >> $GITHUB_ENV

    # 6. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ Node.js ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci

    - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        if [ -f magic-number/crawlers/requirements.txt ]; then
          pip install -r magic-number/crawlers/requirements.txt
        else
          pip install selenium beautifulsoup4
        fi

    # 7. ê²½ë¡œ ì‹œìŠ¤í…œ ê²€ì¦
    - name: ğŸ” í”„ë¡œì íŠ¸ ê²½ë¡œ ê²€ì¦
      run: npm test

    # 8. KBO ë°ì´í„° í¬ë¡¤ë§ (ì¡°ê±´ë¶€)
    - name: ğŸ•·ï¸ KBO ë°ì´í„° í¬ë¡¤ë§
      if: ${{ github.event.inputs.skip_crawling != 'true' }}
      run: |
        echo "ğŸš€ KBO í¬ë¡¤ë§ ì‹œì‘..."
        npm run crawl
        CRAWL_EXIT_CODE=$?
        if [ $CRAWL_EXIT_CODE -ne 0 ]; then
          echo "âŒ í¬ë¡¤ë§ ì‹¤íŒ¨ (Exit code: $CRAWL_EXIT_CODE)"
          echo "ğŸ” í¬ë¡¤ë§ ì—ëŸ¬ ë°œìƒ - ë°ì´í„° ì†ŒìŠ¤ í™•ì¸ í•„ìš”"
          exit 1
        fi
        echo "âœ… í¬ë¡¤ë§ ì™„ë£Œ"

    # 9. í¬ë¡¤ë§ ë°ì´í„° ê²€ì¦
    - name: ğŸ” í¬ë¡¤ë§ ë°ì´í„° ê²€ì¦
      if: ${{ github.event.inputs.skip_crawling != 'true' }}
      run: |
        echo "ğŸ“‹ í¬ë¡¤ë§ëœ ë°ì´í„° ê²€ì¦ ì¤‘..."
        
        # 2025-season-data-clean.txt íŒŒì¼ í™•ì¸
        if [ ! -f "magic-number/data/2025-season-data-clean.txt" ]; then
          echo "âŒ 2025-season-data-clean.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        
        # íŒŒì¼ í¬ê¸° í™•ì¸ (ìµœì†Œ 1KB ì´ìƒ)
        FILE_SIZE=$(stat -f%z "magic-number/data/2025-season-data-clean.txt" 2>/dev/null || stat -c%s "magic-number/data/2025-season-data-clean.txt" 2>/dev/null)
        if [ "$FILE_SIZE" -lt 1024 ]; then
          echo "âŒ ë°ì´í„° íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤ (í¬ê¸°: ${FILE_SIZE} bytes)"
          exit 1
        fi
        
        # ì˜¤ëŠ˜ ë‚ ì§œ ë°ì´í„° í™•ì¸
        TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
        if grep -q "$TODAY" "magic-number/data/2025-season-data-clean.txt"; then
          echo "âœ… ì˜¤ëŠ˜($TODAY) ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
        else
          echo "âš ï¸ ì˜¤ëŠ˜($TODAY) ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ê²½ê¸°ê°€ ì—†ê±°ë‚˜ ì•„ì§ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ)"
        fi
        
        echo "âœ… ë°ì´í„° ê²€ì¦ ì™„ë£Œ"

    # 10. ë°ì´í„° ì²˜ë¦¬ ë° ë³€í™˜
    - name: ğŸ“Š ì‹œì¦Œ ë°ì´í„° ì²˜ë¦¬
      run: |
        echo "ğŸ“ˆ ì‹œì¦Œ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘..."
        npm run process
        echo "âœ… ê¸°ë³¸ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ"

    # 10-1. ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
    - name: ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
      run: |
        echo "ğŸ—„ï¸ SQLite ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."
        npm run database-update
        echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    # 10-2. ì¶”ê°€ ë¶„ì„ ë°ì´í„° ìƒì„± (ë£¨íŠ¸ index.htmlìš©)
    - name: ğŸ“ˆ ê³ ê¸‰ ë¶„ì„ ë°ì´í„° ìƒì„±
      run: |
        echo "ğŸ” ê³ ê¸‰ ë¶„ì„ ë°ì´í„° ìƒì„± ì¤‘..."
        npm run analysis
        echo "âœ… ëª¨ë“  ë¶„ì„ ë°ì´í„° ìƒì„± ì™„ë£Œ"

    # 11. ìë™ ë°±ì—… ìƒì„±
    - name: ğŸ’¾ ìë™ ë°±ì—… ìƒì„±
      run: |
        echo "ğŸ”„ ì¤‘ìš” ë°ì´í„° ë°±ì—… ìƒì„± ì¤‘..."
        npm run backup
        echo "âœ… ë°±ì—… ìƒì„± ì™„ë£Œ"
        
    # 12. ì¼ì¼ ìŠ¤ëƒ…ìƒ· ì €ì¥
    - name: ğŸ“¸ ì¼ì¼ ìˆœìœ„ ìŠ¤ëƒ…ìƒ· ì €ì¥
      run: |
        echo "ğŸ’¾ ì¼ì¼ ìŠ¤ëƒ…ìƒ· ì €ì¥ ì¤‘..."
        npm run snapshot
        echo "âœ… ìŠ¤ëƒ…ìƒ· ì €ì¥ ì™„ë£Œ"
        
    # 13. ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
    - name: ğŸ“ ë³€ê²½ì‚¬í•­ í™•ì¸
      id: check_changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "KBO Auto Crawler"
        
        # ë³€ê²½ì‚¬í•­ ìˆëŠ”ì§€ í™•ì¸
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ ë°œê²¬ë¨"
          git status --short
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi

    # 13. ìë™ ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
    - name: ğŸ”„ ìë™ ì»¤ë°‹ ë° í‘¸ì‹œ
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # í˜„ì¬ ì‹œê°„ (í•œêµ­ì‹œê°„)
        CURRENT_TIME=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M')
        CURRENT_HOUR=$(TZ='Asia/Seoul' date '+%H')
        
        # ì‹œê°„ëŒ€ë³„ ì´ëª¨ì§€ ë° ë©”ì‹œì§€
        if [ "$CURRENT_HOUR" -ge 18 ] && [ "$CURRENT_HOUR" -lt 22 ]; then
          TIME_EMOJI="ğŸŒ…"
          TIME_MSG="ì˜¤í›„ 6ì‹œ ê²½ê¸° ê²°ê³¼ ì—…ë°ì´íŠ¸"
        elif [ "$CURRENT_HOUR" -ge 22 ] || [ "$CURRENT_HOUR" -lt 2 ]; then
          TIME_EMOJI="ğŸŒ†"
          TIME_MSG="ì˜¤í›„ 10ì‹œ ê²½ê¸° ê²°ê³¼ ì—…ë°ì´íŠ¸"
        else
          TIME_EMOJI="ğŸŒ™"
          TIME_MSG="ìµœì¢… ê²½ê¸° ê²°ê³¼ ì—…ë°ì´íŠ¸"
        fi
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        git add .
        git commit -m "ğŸ¤– KBO ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ - ${CURRENT_TIME}

        ${TIME_EMOJI} ${TIME_MSG}
        ğŸ¯ PathManager ê¸°ë°˜ ì•ˆì •ì  ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ
        ğŸ“Š ìˆœìœ„í‘œ, ë§¤ì§ë„˜ë²„, ìƒëŒ€ì „ì  ì—…ë°ì´íŠ¸
        ğŸ“¸ ì¼ì¼ ìŠ¤ëƒ…ìƒ· íˆìŠ¤í† ë¦¬ ì €ì¥
        
        ğŸ¤– Generated with GitHub Actions
        Co-Authored-By: KBO-Auto-Crawler <action@github.com>"
        
        # í‘¸ì‹œ ì‹¤í–‰
        git push
        echo "âœ… ìë™ ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"

    # 14. ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¯ KBO ìë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ - $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M')"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # ë°ì´í„° íŒŒì¼ í™•ì¸
        echo "ğŸ“ ë°ì´í„° íŒŒì¼ í˜„í™©:"
        if [ -f magic-number/data/service-data.json ]; then
          SERVICE_SIZE=$(du -h magic-number/data/service-data.json | cut -f1)
          echo "  âœ… service-data.json (${SERVICE_SIZE})"
        fi
        if [ -f magic-number/data/kbo-rankings.json ]; then
          RANKING_SIZE=$(du -h magic-number/data/kbo-rankings.json | cut -f1)
          echo "  âœ… kbo-rankings.json (${RANKING_SIZE})"
        fi
        if [ -f magic-number/history/daily/$(TZ='Asia/Seoul' date '+%Y-%m-%d').json ]; then
          SNAPSHOT_SIZE=$(du -h magic-number/history/daily/$(TZ='Asia/Seoul' date '+%Y-%m-%d').json | cut -f1)
          echo "  âœ… ì˜¤ëŠ˜ ìŠ¤ëƒ…ìƒ· (${SNAPSHOT_SIZE})"
        fi
        
        # íˆìŠ¤í† ë¦¬ í†µê³„
        if [ -d magic-number/history/daily ]; then
          DAILY_COUNT=$(ls -1 magic-number/history/daily/*.json 2>/dev/null | wc -l)
          echo "  ğŸ“ˆ ì´ íˆìŠ¤í† ë¦¬: ${DAILY_COUNT}ê°œ ì¼ì¼ ìŠ¤ëƒ…ìƒ·"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # 15. íŒŒì¼ í™•ì¸ (PagesëŠ” main ë¸Œëœì¹˜ì—ì„œ ìë™ ë°°í¬ë¨)
    - name: ğŸ“ ë°°í¬ íŒŒì¼ í™•ì¸
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        echo "ğŸŒ GitHub Pages ìë™ ë°°í¬ í™•ì¸..."
        
        # magic-number í´ë” ì¡´ì¬ í™•ì¸
        if [ ! -d "magic-number" ]; then
          echo "âŒ magic-number í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # ì£¼ìš” íŒŒì¼ë“¤ í™•ì¸
        echo "ğŸ“ ì—…ë°ì´íŠ¸ëœ íŒŒì¼ë“¤:"
        echo "  - index.html: $([ -f index.html ] && echo 'âœ…' || echo 'âŒ')"
        echo "  - magic-number/index.html: $([ -f magic-number/index.html ] && echo 'âœ…' || echo 'âŒ')"
        echo "  - service-data.json: $([ -f magic-number/data/service-data.json ] && echo 'âœ…' || echo 'âŒ')"
        echo "  - kbo-rankings.json: $([ -f magic-number/data/kbo-rankings.json ] && echo 'âœ…' || echo 'âŒ')"
        
        # íˆìŠ¤í† ë¦¬ íŒŒì¼ ìˆ˜ í™•ì¸
        if [ -d magic-number/history/daily ]; then
          HISTORY_COUNT=$(ls -1 magic-number/history/daily/*.json 2>/dev/null | wc -l)
          echo "  - ì¼ì¼ íˆìŠ¤í† ë¦¬: ${HISTORY_COUNT}ê°œ íŒŒì¼"
        fi
        
        echo "âœ… íŒŒì¼ í™•ì¸ ì™„ë£Œ - ë£¨íŠ¸ ë° magic-number ëª¨ë‘ ë°°í¬ ì¤€ë¹„ë¨"

    # 16. GitHub Pages ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
    - name: ğŸ“¦ Pages ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: steps.check_changes.outputs.changes_detected == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        # ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ Pagesë¡œ ì—…ë¡œë“œ (ë£¨íŠ¸ index.html í¬í•¨)
        path: '.'
        
    # 17. GitHub Pages ë°°í¬
    - name: ğŸŒ GitHub Pages ë°°í¬
      if: steps.check_changes.outputs.changes_detected == 'true'
      id: deployment
      uses: actions/deploy-pages@v4
        
    # 18. ë°°í¬ ì™„ë£Œ í™•ì¸
    - name: âœ… ë°°í¬ ì™„ë£Œ í™•ì¸
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        echo "ğŸš€ GitHub Pages ë°°í¬ ì™„ë£Œ!"
        echo "ğŸŒ ë°°í¬ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“Š JSON ì—…ë°ì´íŠ¸ê°€ ì¦‰ì‹œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤"

    # 19. ìµœì¢… ì™„ë£Œ ì•Œë¦¼
    - name: ğŸ‰ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ì•Œë¦¼
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¯ KBO ìë™ ì—…ë°ì´íŠ¸ & ë°°í¬ ì™„ë£Œ - $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M')"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ "${{ steps.check_changes.outputs.changes_detected }}" == "true" ]; then
          echo "âœ… ë°ì´í„° ì—…ë°ì´íŠ¸: ì™„ë£Œ"
          echo "âœ… ìë™ ì»¤ë°‹: ì™„ë£Œ" 
          echo "âœ… GitHub Pages ë°°í¬: ì™„ë£Œ"
          if [ -n "${{ steps.deployment.outputs.page_url }}" ]; then
            echo "ğŸŒ ë°°í¬ URL: ${{ steps.deployment.outputs.page_url }}"
          else
            echo "ğŸŒ ë°°í¬ URL: https://kbo.mahalohana-bruce.com"
          fi
        else
          echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ì„œ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤"
        fi
        
        echo "ğŸ“… ë‹¤ìŒ ì‹¤í–‰ ìŠ¤ì¼€ì¤„:"
        echo "   - ğŸŒ… ì˜¤í›„ 6ì‹œ (í•œêµ­ì‹œê°„ 18:00)"
        echo "   - ğŸŒ† ì˜¤í›„ 10ì‹œ (í•œêµ­ì‹œê°„ 22:00)"  
        echo "   - ğŸŒ™ ë°¤ 12ì‹œ (í•œêµ­ì‹œê°„ 00:00)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"