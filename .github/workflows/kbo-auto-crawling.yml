name: KBO ìë™ ë°ì´í„° í¬ë¡¤ë§ ë° ì—…ë°ì´íŠ¸

on:
  # í•˜ë£¨ 3ë²ˆ í•œêµ­ì‹œê°„ ê¸°ì¤€ ì‹¤í–‰
  schedule:
    # ì˜¤í›„ 6ì‹œ (UTC 09:00)
    - cron: '0 9 * * *'
    # ì˜¤í›„ 10ì‹œ (UTC 13:00)  
    - cron: '0 13 * * *'
    # ë°¤ 12ì‹œ (UTC 15:00)
    - cron: '0 15 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      target_date:
        description: 'í¬ë¡¤ë§í•  ë‚ ì§œ (YYYY-MM-DD, ë¹„ì–´ìˆìœ¼ë©´ í˜„ì¬ ì›”)'
        required: false
        type: string

jobs:
  crawl-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Node.js í™˜ê²½ ì„¤ì •  
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Chrome ì„¤ì¹˜
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
        
    - name: ChromeDriver ì„¤ì¹˜
      uses: nanasess/setup-chromedriver@master
    
    - name: Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Node.js ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
    
    - name: KBO ë°ì´í„° í¬ë¡¤ë§ ì‹¤í–‰
      run: |
        echo "ğŸš€ KBO ë°ì´í„° í¬ë¡¤ë§ ì‹œì‘..."
        
        # í˜„ì¬ ë…„ì›” ê³„ì‚° (í•œêµ­ì‹œê°„ ê¸°ì¤€)
        CURRENT_YEAR=$(TZ='Asia/Seoul' date +%Y)
        CURRENT_MONTH=$(TZ='Asia/Seoul' date +%m)
        
        echo "ğŸ“… í¬ë¡¤ë§ ëŒ€ìƒ: ${CURRENT_YEAR}ë…„ ${CURRENT_MONTH}ì›”"
        
        # Python í¬ë¡¤ëŸ¬ ì‹¤í–‰ (headless ëª¨ë“œ)
        python kbo-python-working-crawler.py
        
        # data í´ë” í™•ì¸ ë° ìƒì„±
        mkdir -p data
        
        # í¬ë¡¤ë§ ê²°ê³¼ í™•ì¸ (ì´ì œ clean.txt íŒŒì¼ì— ì§ì ‘ ì¶”ê°€ë¨)
        echo "ğŸ“ í¬ë¡¤ë§ ì™„ë£Œ - data/${CURRENT_YEAR}-season-data-clean.txt ì—…ë°ì´íŠ¸ë¨"
    
    - name: Node.js ë°ì´í„° ì²˜ë¦¬ ì‹¤í–‰
      run: |
        echo "ğŸ”„ Node.js ë°ì´í„° ì²˜ë¦¬ ì‹œì‘..."
        
        # í˜„ì¬ ì—°ë„ ê³„ì‚°
        CURRENT_YEAR=$(TZ='Asia/Seoul' date +%Y)
        
        # clean.txt íŒŒì¼ì„ Node.jsë¡œ ì²˜ë¦¬
        if [ -f "data/${CURRENT_YEAR}-season-data-clean.txt" ]; then
          # process-season-data.jsê°€ clean.txt íŒŒì¼ì„ ì½ë„ë¡ ì„¤ì •ë˜ì–´ ìˆìŒ
          node scripts/process-season-data.js
          echo "âœ… ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ"
        else
          echo "âš ï¸ ì²˜ë¦¬í•  ì‹œì¦Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: data/${CURRENT_YEAR}-season-data-clean.txt"
          exit 0
        fi
    
    - name: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
      run: |
        echo "ğŸ“ ë³€ê²½ì‚¬í•­ í™•ì¸ ì¤‘..."
        
        # Git ì„¤ì •
        git config --local user.email "action@github.com"
        git config --local user.name "KBO Auto Crawler"
        
        # ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
        git add -A
        
        if git diff --staged --quiet; then
          echo "ğŸ“­ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          exit 0
        fi
        
        # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
        CURRENT_DATE=$(TZ='Asia/Seoul' date +"%Y-%m-%d %H:%M")
        CURRENT_TIME=$(TZ='Asia/Seoul' date +"%H:%M")
        
        # ì‹¤í–‰ ì‹œê°„ì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
        if [[ "$CURRENT_TIME" < "19:00" ]]; then
          TIME_MSG="ğŸŒ… ì˜¤í›„ 6ì‹œ ê²½ê¸° ê²°ê³¼ ì—…ë°ì´íŠ¸"
        elif [[ "$CURRENT_TIME" < "23:00" ]]; then
          TIME_MSG="ğŸŒ† ì˜¤í›„ 10ì‹œ ê²½ê¸° ê²°ê³¼ ì—…ë°ì´íŠ¸"
        else
          TIME_MSG="ğŸŒ™ ë°¤ 12ì‹œ ìµœì¢… ê²½ê¸° ê²°ê³¼ ì—…ë°ì´íŠ¸"
        fi
        
        COMMIT_MESSAGE="ğŸ¤– KBO ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ - ${CURRENT_DATE}
        
        ${TIME_MSG}
        ğŸ¯ ìë™ í¬ë¡¤ë§ ë° ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ
        ğŸ“Š ì›¹ì„œë¹„ìŠ¤ ë°ì´í„° íŒŒì¼ ì—…ë°ì´íŠ¸
        
        ğŸ¤– Generated with GitHub Actions
        Co-Authored-By: KBO-Auto-Crawler <action@github.com>"
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        git commit -m "$COMMIT_MESSAGE"
        
        echo "âœ… ì»¤ë°‹ ì™„ë£Œ: $COMMIT_MESSAGE"
    
    - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: í¬ë¡¤ë§ ê²°ê³¼ ìš”ì•½
      run: |
        echo "ğŸ‰ KBO ìë™ í¬ë¡¤ë§ ì™„ë£Œ!"
        echo "ğŸ“Š ì—…ë°ì´íŠ¸ëœ íŒŒì¼ë“¤:"
        echo "   - magic-number/kbo-rankings.json (ìˆœìœ„ ë°ì´í„°)"
        echo "   - magic-number/kbo-records.json (ìƒëŒ€ì „ì  ë°ì´í„°)"  
        echo "   - output/service-data.json (í†µí•© ì„œë¹„ìŠ¤ ë°ì´í„°)"
        echo "ğŸ“… ë‹¤ìŒ ì‹¤í–‰ ìŠ¤ì¼€ì¤„:"
        echo "   - ğŸŒ… ì˜¤í›„ 6ì‹œ (í•œêµ­ì‹œê°„)"
        echo "   - ğŸŒ† ì˜¤í›„ 10ì‹œ (í•œêµ­ì‹œê°„)"
        echo "   - ğŸŒ™ ë°¤ 12ì‹œ (í•œêµ­ì‹œê°„)"
    
    - name: ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      if: failure()
      run: |
        echo "âŒ KBO ìë™ í¬ë¡¤ë§ ì‹¤íŒ¨"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”"
        # ì—¬ê¸°ì— Slack, Discord ë“± ì•Œë¦¼ ì—°ë™ ê°€ëŠ¥