name: ğŸˆ NPB Auto Data Update

on:
  push:
    branches: [ main ]
    paths:
      - 'crawler/**'
      - '*.sh'
      - '.github/workflows/npb-auto-update.yml'
  schedule:
    # ğŸ•°ï¸ í•œêµ­ì‹œê°„ 17:00~22:30 (UTC 08:00~13:30) êµ¬ê°„ì„ 15ë¶„ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰
    - cron: '0 8 * * *'
    - cron: '15 8 * * *'
    - cron: '30 8 * * *'
    - cron: '45 8 * * *'
    - cron: '0 9 * * *'
    - cron: '15 9 * * *'
    - cron: '30 9 * * *'
    - cron: '45 9 * * *'
    - cron: '0 10 * * *'
    - cron: '15 10 * * *'
    - cron: '30 10 * * *'
    - cron: '45 10 * * *'
    - cron: '0 11 * * *'
    - cron: '15 11 * * *'
    - cron: '30 11 * * *'
    - cron: '45 11 * * *'
    - cron: '0 12 * * *'
    - cron: '15 12 * * *'
    - cron: '30 12 * * *'
    - cron: '45 12 * * *'
    - cron: '0 13 * * *'
    - cron: '15 13 * * *'
    - cron: '30 13 * * *'
  workflow_dispatch:
    inputs:
      skip_crawling:
        description: 'í¬ë¡¤ë§ ê±´ë„ˆë›°ê¸° (ë³€í™˜ë§Œ)'
        required: false
        default: 'false'
        type: choice
        options: ['false','true']

permissions:
  contents: write
  actions: read

concurrency:
  group: npb-auto-update-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Asia/Seoul

jobs:
  auto-update:
    name: ğŸ¤– Auto Update NPB Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'crawler/requirements.txt'

      - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f crawler/requirements.txt ]; then
            pip install -r crawler/requirements.txt
          else
            pip install requests beautifulsoup4 lxml
          fi
        timeout-minutes: 5

      - name: ğŸ”„ NPB ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
        run: |
          chmod +x ./run_new_pipeline.sh
          set -e
          
          if [ "${{ github.event.inputs.skip_crawling }}" = "true" ]; then
            echo "â­ï¸ í¬ë¡¤ë§ ê±´ë„ˆë›°ê³  ë³€í™˜ë§Œ ì‹¤í–‰"
            ./run_new_pipeline.sh --skip-crawl
          else
            echo "ğŸƒâ€â™‚ï¸ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ìµœê·¼ 1ì¼ ë°ì´í„°)"
            ./run_new_pipeline.sh 1
          fi
        timeout-minutes: 20
        continue-on-error: false

      - name: ğŸ“Š ìµœì¢… ë°ì´í„° í˜„í™© í™•ì¸
        run: |
          echo "ğŸ” NPB ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½"
          echo "========================================"
          
          # JSON íŒŒì¼ë“¤ í™•ì¸
          echo "ğŸ“„ ìƒì„±ëœ JSON íŒŒì¼ë“¤:"
          if [ -f "data/standings.json" ]; then
            STANDINGS_SIZE=$(stat -f%z "data/standings.json" 2>/dev/null || stat -c%s "data/standings.json" 2>/dev/null || echo "0")
            echo "  âœ… standings.json (${STANDINGS_SIZE} bytes)"
            
            # ìˆœìœ„í‘œ íŒ€ ìˆ˜ í™•ì¸
            if command -v jq >/dev/null 2>&1; then
              CENTRAL_TEAMS=$(jq -r '.central | length' data/standings.json 2>/dev/null || echo "?")
              PACIFIC_TEAMS=$(jq -r '.pacific | length' data/standings.json 2>/dev/null || echo "?")
              echo "     ğŸ“ˆ ì„¼íŠ¸ëŸ´ë¦¬ê·¸: ${CENTRAL_TEAMS}íŒ€, í¼ì‹œí”½ë¦¬ê·¸: ${PACIFIC_TEAMS}íŒ€"
            fi
          else
            echo "  âŒ standings.json ìƒì„± ì‹¤íŒ¨"
          fi
          
          if [ -f "data/games.json" ]; then
            GAMES_SIZE=$(stat -f%z "data/games.json" 2>/dev/null || stat -c%s "data/games.json" 2>/dev/null || echo "0")
            echo "  âœ… games.json (${GAMES_SIZE} bytes)"
            
            # ê²½ê¸° ìˆ˜ í™•ì¸
            if command -v jq >/dev/null 2>&1; then
              GAMES_COUNT=$(jq '. | length' data/games.json 2>/dev/null || echo "?")
              echo "     âš¾ ì´ ê²½ê¸° ìˆ˜: ${GAMES_COUNT}ê²½ê¸°"
            fi
          else
            echo "  âŒ games.json ìƒì„± ì‹¤íŒ¨"
          fi
          
          if [ -f "data/upcoming.json" ]; then
            UPCOMING_SIZE=$(stat -f%z "data/upcoming.json" 2>/dev/null || stat -c%s "data/upcoming.json" 2>/dev/null || echo "0")
            echo "  âœ… upcoming.json (${UPCOMING_SIZE} bytes)"
            
            # ì˜ˆì • ê²½ê¸° ìˆ˜ í™•ì¸
            if command -v jq >/dev/null 2>&1; then
              UPCOMING_COUNT=$(jq '. | length' data/upcoming.json 2>/dev/null || echo "?")
              echo "     ğŸ“… ì˜ˆì • ê²½ê¸° ìˆ˜: ${UPCOMING_COUNT}ê²½ê¸°"
            fi
          else
            echo "  âŒ upcoming.json ìƒì„± ì‹¤íŒ¨"
          fi
          
          if [ -f "data/dashboard.json" ]; then
            DASHBOARD_SIZE=$(stat -f%z "data/dashboard.json" 2>/dev/null || stat -c%s "data/dashboard.json" 2>/dev/null || echo "0")
            echo "  âœ… dashboard.json (${DASHBOARD_SIZE} bytes)"
          else
            echo "  âŒ dashboard.json ìƒì„± ì‹¤íŒ¨"
          fi
          
          # ê°„ë‹¨í•œ TXT íŒŒì¼ë“¤ í™•ì¸
          echo ""
          echo "ğŸ“ TXT ë°ì´í„° íŒŒì¼ë“¤:"
          if [ -d "data/simple" ]; then
            TXT_COUNT=$(find data/simple -name "*.txt" -type f | wc -l | tr -d ' ')
            echo "  ğŸ“ data/simple/ ë””ë ‰í† ë¦¬: ${TXT_COUNT}ê°œ íŒŒì¼"
            
            # ìµœì‹  íŒŒì¼ ëª‡ ê°œ í‘œì‹œ
            if [ $TXT_COUNT -gt 0 ]; then
              echo "  ğŸ“‹ ìµœê·¼ ìƒì„±ëœ íŒŒì¼ë“¤:"
              find data/simple -name "*.txt" -type f -exec ls -la {} \; | sort -k6,7 | tail -5 | while read line; do
                echo "     $line"
              done
            fi
          else
            echo "  âŒ data/simple/ ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi
          
          # ë¡œê·¸ íŒŒì¼ í™•ì¸
          echo ""
          echo "ğŸ“‹ ìƒì„±ëœ ë¡œê·¸:"
          if [ -d "logs" ]; then
            find logs -name "*.log" -o -name "*.txt" | sort | while read logfile; do
              if [ -f "$logfile" ]; then
                LOG_SIZE=$(stat -f%z "$logfile" 2>/dev/null || stat -c%s "$logfile" 2>/dev/null || echo "0")
                echo "  ğŸ“„ $logfile (${LOG_SIZE} bytes)"
              fi
            done
          fi
          
          # ì‹¤ì œ ìˆ˜ì§‘ëœ ê²½ê¸° ë°ì´í„° ë‚´ìš© í‘œì‹œ
          echo ""
          echo "âš¾ ìˆ˜ì§‘ëœ ìµœì‹  ê²½ê¸° ë°ì´í„°:"
          echo "========================"
          
          if [ -f "data/games.json" ] && command -v jq >/dev/null 2>&1; then
            # ì˜¤ëŠ˜ ë‚ ì§œ (KST ê¸°ì¤€)
            TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
            echo "ğŸ† ì˜¤ëŠ˜($TODAY) ì¢…ë£Œëœ ê²½ê¸°:"
            
            TODAY_GAMES=$(jq -r --arg today "$TODAY" '.[] | select(.date == $today and (.status == "completed" or .status == "çµ‚äº†" or .finished == true)) | "\(.home_team) \(.home_score) - \(.away_score) \(.away_team) [\(.status // "ì¢…ë£Œ")]"' data/games.json 2>/dev/null)
            
            if [ -n "$TODAY_GAMES" ]; then
              echo "$TODAY_GAMES" | while read game; do
                echo "  âš¾ $game"
              done
            else
              echo "  ğŸ” ì˜¤ëŠ˜ ì¢…ë£Œëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤"
            fi
            
            echo ""
            echo "ğŸ“… ìµœê·¼ ì™„ë£Œëœ ê²½ê¸° (ìµœëŒ€ 3ê²½ê¸°):"
            jq -r '.[] | select(.status == "completed" or .status == "çµ‚äº†" or .finished == true) | "\(.date) \(.home_team) \(.home_score) - \(.away_score) \(.away_team)"' data/games.json 2>/dev/null | tail -3 | while read game; do
              echo "  ğŸ“Š $game"
            done
            
            echo ""
            echo "ğŸ“… ì˜ˆì •ëœ ê²½ê¸° (ìµœëŒ€ 3ê²½ê¸°):"
            jq -r '.[] | select(.status != "completed" and .status != "çµ‚äº†" and .finished != true) | "\(.date) \(.time // "ì‹œê°„ë¯¸ì •") - \(.home_team) vs \(.away_team)"' data/games.json 2>/dev/null | head -3 | while read game; do
              echo "  ğŸ• $game"
            done
          else
            echo "  âŒ ê²½ê¸° ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (games.json ë˜ëŠ” jq ì—†ìŒ)"
          fi
          
          echo ""
          if [ -f "data/standings.json" ] && command -v jq >/dev/null 2>&1; then
            echo "ğŸ“Š í˜„ì¬ ìˆœìœ„í‘œ ìƒìœ„ 3íŒ€:"
            echo "  ğŸ† ì„¼íŠ¸ëŸ´ë¦¬ê·¸:"
            jq -r '.central[0:3][] | "    \(.rank // "?")ìœ„ \(.team) (\(.wins // 0)ìŠ¹\(.losses // 0)íŒ¨ ìŠ¹ë¥ \(.win_rate // "?"))"' data/standings.json 2>/dev/null || echo "    âŒ ì„¼íŠ¸ëŸ´ë¦¬ê·¸ ë°ì´í„° ì—†ìŒ"
            
            echo "  ğŸ† í¼ì‹œí”½ë¦¬ê·¸:"
            jq -r '.pacific[0:3][] | "    \(.rank // "?")ìœ„ \(.team) (\(.wins // 0)ìŠ¹\(.losses // 0)íŒ¨ ìŠ¹ë¥ \(.win_rate // "?"))"' data/standings.json 2>/dev/null || echo "    âŒ í¼ì‹œí”½ë¦¬ê·¸ ë°ì´í„° ì—†ìŒ"
          else
            echo "ğŸ“Š ìˆœìœ„í‘œ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo ""
          echo "ğŸ”¢ ì „ì²´ ë°ì´í„° í†µê³„:"
          if [ -f "data/dashboard.json" ] && command -v jq >/dev/null 2>&1; then
            TOTAL_GAMES=$(jq -r '.stats.total_games // "?"' data/dashboard.json 2>/dev/null)
            COMPLETED_GAMES=$(jq -r '.stats.completed_games // "?"' data/dashboard.json 2>/dev/null)
            REMAINING_GAMES=$(jq -r '.stats.remaining_games // "?"' data/dashboard.json 2>/dev/null)
            LAST_UPDATE=$(jq -r '.last_updated // "?"' data/dashboard.json 2>/dev/null)
            
            echo "  ğŸ“ˆ ì „ì²´ ê²½ê¸°: ${TOTAL_GAMES}ê²½ê¸°"
            echo "  âœ… ì™„ë£Œëœ ê²½ê¸°: ${COMPLETED_GAMES}ê²½ê¸°" 
            echo "  â³ ë‚¨ì€ ê²½ê¸°: ${REMAINING_GAMES}ê²½ê¸°"
            echo "  ğŸ• ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${LAST_UPDATE}"
          else
            echo "  âŒ ëŒ€ì‹œë³´ë“œ í†µê³„ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo ""
          echo "âœ¨ ì‹¤ì œ ë°ì´í„° ë‚´ìš© í‘œì‹œ ì™„ë£Œ"

      - name: ğŸ“ ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        run: |
          # Git ì‚¬ìš©ì ì„¤ì •
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ë³€ê²½ëœ íŒŒì¼ ì¶”ê°€
          git add data/simple/*.txt 2>/dev/null || true
          git add data/*.json 2>/dev/null || true
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if ! git diff --cached --quiet; then
            # í•œêµ­ ì‹œê°„ìœ¼ë¡œ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            CURRENT_TIME=$(date '+%Y-%m-%d %H:%M KST')
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            
            echo "âœ… ${CHANGED_FILES}ê°œ íŒŒì¼ ë³€ê²½ ê°ì§€"
            
            # ì»¤ë°‹ ë° í‘¸ì‹œ
            git commit -m "ğŸ¤– NPB ìë™ ì—…ë°ì´íŠ¸ - ${CURRENT_TIME}
            
            ğŸ“ˆ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°:
            - NPB ìˆœìœ„í‘œ ë° ê²½ê¸° ê²°ê³¼
            - ë‚¨ì€ ê²½ê¸° ì¼ì •
            - ëŒ€ì‹œë³´ë“œ í†µê³„
            
            ğŸš€ Generated by GitHub Actions"
            
            # ì¬ì‹œë„ ë¡œì§ì„ í¬í•¨í•œ í‘¸ì‹œ
            for i in {1..3}; do
              if git push; then
                echo "âœ… í‘¸ì‹œ ì„±ê³µ (ì‹œë„: $i)"
                break
              else
                echo "âŒ í‘¸ì‹œ ì‹¤íŒ¨ (ì‹œë„: $i/3)"
                if [ $i -lt 3 ]; then
                  echo "â³ 5ì´ˆ í›„ ì¬ì‹œë„..."
                  sleep 5
                  git pull --rebase origin main || true
                fi
              fi
            done
          else
            echo "â„¹ï¸ ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"
          fi
        timeout-minutes: 5
