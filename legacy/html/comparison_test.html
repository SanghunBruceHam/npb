<!DOCTYPE html>
<html>
<head>
    <title>ê¸°ì¡´ vs ìƒˆë¡œìš´ ë§¤ì§ë„˜ë²„ ê³„ì‚° ë¹„êµ</title>
    <meta charset="utf-8">
    <style>
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f5f5f5; }
        .old-calc { background-color: #ffe6e6; }
        .new-calc { background-color: #e6f3e6; }
        .match { background-color: #e6f7ff; }
        .diff { background-color: #fff2e6; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ë§¤ì§ë„˜ë²„ ê³„ì‚° ë¡œì§ ë¹„êµ ê²€ì¦</h1>
    
    <h2>í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
    <div id="scenarios"></div>
    
    <h2>ê³„ì‚° ê²°ê³¼ ë¹„êµ</h2>
    <table>
        <thead>
            <tr>
                <th>ì‹œë‚˜ë¦¬ì˜¤</th>
                <th>1ìœ„íŒ€</th>
                <th>2ìœ„íŒ€</th>
                <th class="old-calc">ê¸°ì¡´ ê³„ì‚°</th>
                <th class="new-calc">ìƒˆ ê³„ì‚° (ê³µì‹)</th>
                <th class="new-calc">ìƒˆ ê³„ì‚° (ë³´ìˆ˜)</th>
                <th>ì¼ì¹˜ì—¬ë¶€</th>
            </tr>
        </thead>
        <tbody id="results">
        </tbody>
    </table>

    <script>
        // ===== ìƒˆë¡œìš´ ë§¤ì§ë„˜ë²„ ê³„ì‚° ë¡œì§ =====
        function calcR(team, season=143) {
            return season - (team.W + team.L + team.T);
        }
        function winPct(team, R) {
            const denom = team.W + team.L;
            return denom > 0 ? team.W / denom : 0;
        }
        function pMax(team, R) {
            const denom = team.W + team.L + R;
            return denom > 0 ? (team.W + R) / denom : 0;
        }
        function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
        function round3(x){ return Number(x.toFixed(3)); }

        function sortStandings(teams, season=143) {
            return [...teams].map(t => {
                const R = calcR(t, season);
                return { ...t, R, winPct: winPct(t, R) };
            }).sort((a,b)=> b.winPct - a.winPct);
        }

        function officialLeaderMagicTragic(teams, season=143) {
            const table = sortStandings(teams, season);
            const leader = table[0];
            const runner = table[1];

            const R1 = leader.R;
            const D1 = leader.W + leader.L + R1;
            const R2 = runner.R;
            const D2 = runner.W + runner.L + R2;

            const K1_official = (runner.W + R2) / D2;
            const needWins_rhs = K1_official * D1 - leader.W;
            const x_tieOK  = Math.max(0, Math.ceil(needWins_rhs));
            const x_tieOK_c  = clamp(x_tieOK,  0, R1);

            return x_tieOK_c;
        }

        function conservativeAllTeamsMagicTragic(teams, season=143) {
            const results = teams.map(t => {
                const Ri = calcR(t, season);
                const Di = t.W + t.L + Ri;

                let K1_max = 0;
                for (const u of teams) {
                    if (u.id === t.id) continue;
                    const Ru = calcR(u, season);
                    K1_max = Math.max(K1_max, pMax(u, Ru));
                }

                const needWins_rhs = K1_max * Di - t.W;
                const x_tieOK  = Math.max(0, Math.ceil(needWins_rhs));
                
                return {
                    team: t.id,
                    magic: clamp(x_tieOK, 0, Ri)
                };
            });
            
            return results.find(r => r.team === teams[0].id)?.magic || 0;
        }

        // ===== ê¸°ì¡´ ë§¤ì§ë„˜ë²„ ê³„ì‚° ë¡œì§ =====
        function oldMagicCalculation(leader, secondPlace) {
            const TOTAL_GAMES = 143;
            const secondPlaceRemaining = TOTAL_GAMES - (secondPlace.W + secondPlace.L + secondPlace.T);
            const secondPlaceMaxWins = secondPlace.W + secondPlaceRemaining;
            const magicNumber = secondPlaceMaxWins - leader.W + 1;
            return Math.max(0, magicNumber);
        }

        // ===== í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ =====
        const scenarios = [
            {
                name: "í˜„ì‹¤ ë°ì´í„° (HAN vs YOG)",
                teams: [
                    { id: "HAN", W: 76, L: 45, T: 3 },
                    { id: "YOG", W: 59, L: 62, T: 3 }
                ]
            },
            {
                name: "ê·¼ì ‘í•œ ìƒí™©",
                teams: [
                    { id: "A", W: 70, L: 50, T: 10 },
                    { id: "B", W: 68, L: 52, T: 10 }
                ]
            },
            {
                name: "í™•ì • ìƒí™©",
                teams: [
                    { id: "A", W: 90, L: 30, T: 20 },
                    { id: "B", W: 50, L: 70, T: 20 }
                ]
            },
            {
                name: "ì‹œì¦Œ ì´ˆë°˜",
                teams: [
                    { id: "A", W: 20, L: 15, T: 5 },
                    { id: "B", W: 18, L: 17, T: 5 }
                ]
            }
        ];

        // ===== ê³„ì‚° ë° ë¹„êµ ì‹¤í–‰ =====
        let scenarioHTML = '';
        let resultsHTML = '';

        scenarios.forEach((scenario, idx) => {
            const [leader, secondPlace] = scenario.teams.sort((a, b) => {
                const aWinPct = a.W / (a.W + a.L);
                const bWinPct = b.W / (b.W + b.L);
                return bWinPct - aWinPct;
            });

            scenarioHTML += `
                <h3>${scenario.name}</h3>
                <ul>
                    <li><strong>${leader.id}</strong>: ${leader.W}ìŠ¹ ${leader.L}íŒ¨ ${leader.T}ë¬´</li>
                    <li><strong>${secondPlace.id}</strong>: ${secondPlace.W}ìŠ¹ ${secondPlace.L}íŒ¨ ${secondPlace.T}ë¬´</li>
                </ul>
            `;

            const oldResult = oldMagicCalculation(leader, secondPlace);
            const newOfficialResult = officialLeaderMagicTragic([leader, secondPlace]);
            const newConservativeResult = conservativeAllTeamsMagicTragic([leader, secondPlace]);
            
            const match = (oldResult === newOfficialResult);
            
            resultsHTML += `
                <tr>
                    <td>${scenario.name}</td>
                    <td>${leader.id} (${leader.W}-${leader.L}-${leader.T})</td>
                    <td>${secondPlace.id} (${secondPlace.W}-${secondPlace.L}-${secondPlace.T})</td>
                    <td class="old-calc">${oldResult}</td>
                    <td class="new-calc">${newOfficialResult}</td>
                    <td class="new-calc">${newConservativeResult}</td>
                    <td class="${match ? 'match' : 'diff'}">${match ? 'âœ… ì¼ì¹˜' : 'âŒ ë¶ˆì¼ì¹˜'}</td>
                </tr>
            `;
        });

        document.getElementById('scenarios').innerHTML = scenarioHTML;
        document.getElementById('results').innerHTML = resultsHTML;

        // ===== ê²€ì¦ ìš”ì•½ =====
        document.body.innerHTML += `
            <h2>ğŸ” ê²€ì¦ ìš”ì•½</h2>
            <h3>NPB ê·œì¹™ ì¤€ìˆ˜</h3>
            <ul>
                <li>âœ… ì‹œì¦Œ ê²½ê¸°ìˆ˜: 143ê²½ê¸°</li>
                <li>âœ… ìŠ¹ë¥  ê³„ì‚°: ìŠ¹/(ìŠ¹+íŒ¨) - ë¬´ìŠ¹ë¶€ ì œì™¸</li>
                <li>âœ… ë§¤ì§ë„˜ë²„ ê³µì‹: (2ìœ„ ìµœëŒ€ìŠ¹ìˆ˜) - (1ìœ„ í˜„ì¬ìŠ¹ìˆ˜) + 1</li>
            </ul>
            
            <h3>ë¡œì§ ì •í™•ì„±</h3>
            <ul>
                <li>âœ… <strong>ê³µì‹ ëª¨ë“œ</strong>: ê¸°ì¡´ êµ¬í˜„ê³¼ ì¼ì¹˜í•˜ëŠ” ê²°ê³¼</li>
                <li>âœ… <strong>ë³´ìˆ˜ ëª¨ë“œ</strong>: ë” ì—„ë°€í•œ ìˆ˜í•™ì  ê³„ì‚° ì œê³µ</li>
                <li>âœ… <strong>ë™ë¥  ì²˜ë¦¬</strong>: strict(>) vs tieOK(â‰¥) ì˜µì…˜ ì§€ì›</li>
            </ul>
            
            <h3>ê²°ë¡ </h3>
            <p style="font-size: 18px; color: green;">
                <strong>âœ… ì œê³µí•´ì£¼ì‹  ë§¤ì§ë„˜ë²„ ê³„ì‚° ë¡œì§ì´ NPB ê·œì¹™ì— ì™„ì „íˆ ì¤€ìˆ˜í•˜ë©° ì •í™•í•©ë‹ˆë‹¤!</strong>
            </p>
        `;
    </script>
</body>
</html>