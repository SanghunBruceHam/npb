# KBO ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ Windows ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •

param(
    [switch]$Install,
    [switch]$Uninstall,
    [switch]$Test
)

$ProjectPath = $PSScriptRoot
$LogPath = Join-Path $ProjectPath "logs"
$ScriptName = "KBODataUpdate"

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
if (!(Test-Path $LogPath)) {
    New-Item -ItemType Directory -Path $LogPath -Force
    Write-Host "ğŸ“ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±: $LogPath" -ForegroundColor Green
}

# ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
$UpdateScript = @"
# KBO ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸
`$ProjectPath = "$ProjectPath"
`$LogPath = "$LogPath"
`$Timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
`$LogFile = Join-Path `$LogPath "update_`$Timestamp.log"

"ğŸ KBO ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘ - `$Timestamp" | Add-Content `$LogFile

Set-Location `$ProjectPath

# Node.js í™•ì¸
if (!(Get-Command "node" -ErrorAction SilentlyContinue)) {
    "âŒ Node.jsë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. PATHë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." | Add-Content `$LogFile
    exit 1
}

if (!(Get-Command "npm" -ErrorAction SilentlyContinue)) {
    "âŒ npmì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. PATHë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." | Add-Content `$LogFile
    exit 1
}

# ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤í–‰
"ğŸ“Š ë°ì´í„° ìŠ¤í¬ë˜í•‘ ì‹œì‘..." | Add-Content `$LogFile

try {
    npm run update-data *>> `$LogFile
    "âœ… ë°ì´í„° ì—…ë°ì´íŠ¸ ì„±ê³µ!" | Add-Content `$LogFile
    
    # Git ë³€ê²½ì‚¬í•­ í™•ì¸
    `$changes = git status --porcelain
    
    if (`$changes) {
        git add . *>> `$LogFile
        `$commitMessage = "ğŸ¤– KBO ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ - `$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

        - íŒ€ ìˆœìœ„ ë° ì„±ì  ì—…ë°ì´íŠ¸
        - ë§¤ì§ë„˜ë²„ ì¬ê³„ì‚°  
        - í™ˆ/ì›ì • ì „ì  ê°±ì‹ 

        ğŸ¤– Generated by Windows Task Scheduler"
        
        git commit -m "`$commitMessage" *>> `$LogFile
        git push *>> `$LogFile
        
        "ğŸ“¤ Git í‘¸ì‹œ ì™„ë£Œ!" | Add-Content `$LogFile
    } else {
        "ğŸ“Œ ë³€ê²½ì‚¬í•­ ì—†ìŒ" | Add-Content `$LogFile
    }
} catch {
    "âŒ ì˜¤ë¥˜ ë°œìƒ: `$_" | Add-Content `$LogFile
}

"ğŸ ì—…ë°ì´íŠ¸ ì™„ë£Œ - `$(Get-Date -Format 'yyyy-MM-dd_HH-mm-ss')" | Add-Content `$LogFile
"----------------------------------------" | Add-Content `$LogFile

# 7ì¼ ì´ìƒ ëœ ë¡œê·¸ íŒŒì¼ ì •ë¦¬
Get-ChildItem `$LogPath -Name "update_*.log" | Where-Object { 
    `$_.CreationTime -lt (Get-Date).AddDays(-7) 
} | Remove-Item -Force
"@

$UpdateScriptPath = Join-Path $ProjectPath "auto-update.ps1"
$UpdateScript | Out-File -FilePath $UpdateScriptPath -Encoding UTF8

Write-Host "âœ… ìë™ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±: $UpdateScriptPath" -ForegroundColor Green

function Install-Tasks {
    Write-Host "ğŸ•’ Windows ìŠ¤ì¼€ì¤„ëŸ¬ì— ì‘ì—… ë“±ë¡ ì¤‘..." -ForegroundColor Yellow
    
    # 18:00 ì‘ì—…
    $Action1 = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File `"$UpdateScriptPath`""
    $Trigger1 = New-ScheduledTaskTrigger -Daily -At "18:00"
    $Settings1 = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
    Register-ScheduledTask -TaskName "$ScriptName-18" -Action $Action1 -Trigger $Trigger1 -Settings $Settings1 -Description "KBO ë°ì´í„° ì—…ë°ì´íŠ¸ (18:00)" -Force
    
    # 22:00 ì‘ì—…  
    $Action2 = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File `"$UpdateScriptPath`""
    $Trigger2 = New-ScheduledTaskTrigger -Daily -At "22:00"
    $Settings2 = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
    Register-ScheduledTask -TaskName "$ScriptName-22" -Action $Action2 -Trigger $Trigger2 -Settings $Settings2 -Description "KBO ë°ì´í„° ì—…ë°ì´íŠ¸ (22:00)" -Force
    
    # 00:00 ì‘ì—…
    $Action3 = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-ExecutionPolicy Bypass -File `"$UpdateScriptPath`""
    $Trigger3 = New-ScheduledTaskTrigger -Daily -At "00:00"
    $Settings3 = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
    Register-ScheduledTask -TaskName "$ScriptName-00" -Action $Action3 -Trigger $Trigger3 -Settings $Settings3 -Description "KBO ë°ì´í„° ì—…ë°ì´íŠ¸ (00:00)" -Force
    
    Write-Host "âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ë“±ë¡ ì™„ë£Œ!" -ForegroundColor Green
    Write-Host "ğŸ“‹ ë“±ë¡ëœ ì‘ì—…ë“¤:" -ForegroundColor Cyan
    Get-ScheduledTask -TaskName "$ScriptName-*" | Format-Table TaskName, State, NextRunTime
}

function Uninstall-Tasks {
    Write-Host "ğŸ—‘ï¸  ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ì œê±° ì¤‘..." -ForegroundColor Yellow
    
    try {
        Unregister-ScheduledTask -TaskName "$ScriptName-18" -Confirm:$false -ErrorAction SilentlyContinue
        Unregister-ScheduledTask -TaskName "$ScriptName-22" -Confirm:$false -ErrorAction SilentlyContinue  
        Unregister-ScheduledTask -TaskName "$ScriptName-00" -Confirm:$false -ErrorAction SilentlyContinue
        
        Write-Host "âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ì œê±° ì™„ë£Œ!" -ForegroundColor Green
    } catch {
        Write-Host "âš ï¸  ì¼ë¶€ ì‘ì—…ì„ ì œê±°í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: $_" -ForegroundColor Yellow
    }
}

function Test-Update {
    Write-Host "ğŸ§ª ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..." -ForegroundColor Yellow
    
    & $UpdateScriptPath
    
    $LatestLog = Get-ChildItem $LogPath -Name "update_*.log" | Sort-Object CreationTime -Descending | Select-Object -First 1
    
    if ($LatestLog) {
        Write-Host "ğŸ“„ ìµœì‹  ë¡œê·¸ íŒŒì¼: $LatestLog" -ForegroundColor Cyan
        Write-Host "ğŸ“‹ ë¡œê·¸ ë‚´ìš©:" -ForegroundColor Cyan
        Get-Content (Join-Path $LogPath $LatestLog) | Select-Object -Last 10
    }
}

# ë©”ì¸ ì‹¤í–‰ ë¡œì§
if ($Install) {
    Install-Tasks
} elseif ($Uninstall) {
    Uninstall-Tasks
} elseif ($Test) {
    Test-Update
} else {
    Write-Host @"
ğŸš€ KBO ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ Windows ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •

ì‚¬ìš©ë²•:
  .\setup-scheduler.ps1 -Install     # ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ì„¤ì¹˜
  .\setup-scheduler.ps1 -Uninstall   # ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—… ì œê±°
  .\setup-scheduler.ps1 -Test        # ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ í…ŒìŠ¤íŠ¸

ğŸ“… ìŠ¤ì¼€ì¤„:
  - ë§¤ì¼ 18:00
  - ë§¤ì¼ 22:00  
  - ë§¤ì¼ 00:00

ğŸ“ ë¡œê·¸ íŒŒì¼: $LogPath
ğŸ”§ ìˆ˜ë™ ì‹¤í–‰: $UpdateScriptPath

"@ -ForegroundColor Green

    $response = Read-Host "ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…ì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N)"
    if ($response -eq 'y' -or $response -eq 'Y') {
        Install-Tasks
    }
}