const fs = require('fs');

// KBO ÌåÄÎ™Ö Ï†ïÏùò
const teams = ['ÌïúÌôî', 'KIA', 'KT', 'LG', 'Î°ØÎç∞', 'NC', 'ÎëêÏÇ∞', 'SSG', 'ÏÇºÏÑ±', 'ÌÇ§ÏõÄ'];

// ÏõîÎ≥Ñ ÏÑ±Ï†Å Î∂ÑÏÑù Ìï®Ïàò
function parseGameData() {
    const data = fs.readFileSync('../data/2025-season-data-clean.txt', 'utf8');
    const lines = data.split('\n').filter(line => line.trim());
    
    const monthlyStats = {};
    let currentDate = null;
    let currentMonth = null;
    
    for (const line of lines) {
        const cleanLine = line.replace(/^\s*\d+‚Üí/, '').trim();
        
        // ÎÇ†Ïßú ÎùºÏù∏ Ï≤¥ÌÅ¨ (YYYY-MM-DD ÌòïÏãù)
        if (cleanLine.match(/^\d{4}-\d{2}-\d{2}$/)) {
            currentDate = cleanLine;
            currentMonth = cleanLine.substring(0, 7); // YYYY-MM
            
            if (!monthlyStats[currentMonth]) {
                monthlyStats[currentMonth] = {};
                teams.forEach(team => {
                    monthlyStats[currentMonth][team] = {
                        wins: 0,
                        losses: 0,
                        ties: 0,
                        runsFor: 0,
                        runsAgainst: 0,
                        games: []
                    };
                });
            }
            continue;
        }
        
        // Í≤ΩÍ∏∞ Í≤∞Í≥º ÎùºÏù∏ Ï≤¥ÌÅ¨
        if (currentMonth && cleanLine.includes(':')) {
            const gameMatch = cleanLine.match(/^(.+?)\s+(\d+):(\d+)\s+(.+?)(?:\(H\))?$/);
            if (gameMatch) {
                const [, team1, score1Str, score2Str, team2] = gameMatch;
                const score1 = parseInt(score1Str);
                const score2 = parseInt(score2Str);
                
                // ÌåÄÎ™Ö Ï†ïÎ¶¨ (Í≥µÎ∞± Ï†úÍ±∞)
                const cleanTeam1 = team1.trim();
                const cleanTeam2 = team2.trim();
                
                if (teams.includes(cleanTeam1) && teams.includes(cleanTeam2)) {
                    // Team1 ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    monthlyStats[currentMonth][cleanTeam1].runsFor += score1;
                    monthlyStats[currentMonth][cleanTeam1].runsAgainst += score2;
                    monthlyStats[currentMonth][cleanTeam1].games.push({
                        date: currentDate,
                        opponent: cleanTeam2,
                        myScore: score1,
                        oppScore: score2,
                        result: score1 > score2 ? 'W' : (score1 < score2 ? 'L' : 'T')
                    });
                    
                    // Team2 ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    monthlyStats[currentMonth][cleanTeam2].runsFor += score2;
                    monthlyStats[currentMonth][cleanTeam2].runsAgainst += score1;
                    monthlyStats[currentMonth][cleanTeam2].games.push({
                        date: currentDate,
                        opponent: cleanTeam1,
                        myScore: score2,
                        oppScore: score1,
                        result: score2 > score1 ? 'W' : (score2 < score1 ? 'L' : 'T')
                    });
                    
                    // Ïäπ/Ìå®/Î¨¥ Ïπ¥Ïö¥Ìä∏
                    if (score1 > score2) {
                        monthlyStats[currentMonth][cleanTeam1].wins++;
                        monthlyStats[currentMonth][cleanTeam2].losses++;
                    } else if (score1 < score2) {
                        monthlyStats[currentMonth][cleanTeam1].losses++;
                        monthlyStats[currentMonth][cleanTeam2].wins++;
                    } else {
                        monthlyStats[currentMonth][cleanTeam1].ties++;
                        monthlyStats[currentMonth][cleanTeam2].ties++;
                    }
                }
            }
        }
    }
    
    return monthlyStats;
}

// ÏõîÎ≥Ñ ÏÑ±Ï†ÅÌëú ÏÉùÏÑ±
function generateMonthlyMatrix() {
    const monthlyStats = parseGameData();
    const months = Object.keys(monthlyStats).sort();
    
    console.log('=== KBO 2025ÏãúÏ¶å ÏõîÎ≥Ñ ÏÑ±Ï†Å ÏôÑÏ†Ñ Î∂ÑÏÑù ===\n');
    
    // 1. ÏõîÎ≥Ñ ÏäπÎ•† Îß§Ìä∏Î¶≠Ïä§ (ÏõîÏù¥ Ìñâ, ÌåÄÏù¥ Ïó¥)
    console.log('üìä ÏõîÎ≥Ñ ÏäπÎ•† Îß§Ìä∏Î¶≠Ïä§');
    console.log('Ïõî\\ÌåÄ'.padEnd(10), teams.map(team => team.padEnd(8)).join(''));
    console.log('-'.repeat(10 + teams.length * 8));
    
    for (const month of months) {
        const monthName = month.substring(5); // MM Î∂ÄÎ∂ÑÎßå
        process.stdout.write(`${monthName}Ïõî`.padEnd(10));
        
        for (const team of teams) {
            const stats = monthlyStats[month][team];
            const totalGames = stats.wins + stats.losses + stats.ties;
            const winRate = totalGames > 0 ? (stats.wins / totalGames * 100).toFixed(1) : '0.0';
            process.stdout.write(`${winRate}%`.padEnd(8));
        }
        console.log();
    }
    
    console.log('\n');
    
    // 2. ÏõîÎ≥Ñ ÏäπÏàò Îß§Ìä∏Î¶≠Ïä§
    console.log('üèÜ ÏõîÎ≥Ñ ÏäπÏàò Îß§Ìä∏Î¶≠Ïä§');
    console.log('Ïõî\\ÌåÄ'.padEnd(10), teams.map(team => team.padEnd(6)).join(''));
    console.log('-'.repeat(10 + teams.length * 6));
    
    for (const month of months) {
        const monthName = month.substring(5);
        process.stdout.write(`${monthName}Ïõî`.padEnd(10));
        
        for (const team of teams) {
            const wins = monthlyStats[month][team].wins;
            process.stdout.write(`${wins}Ïäπ`.padEnd(6));
        }
        console.log();
    }
    
    console.log('\n');
    
    // 3. ÏõîÎ≥Ñ Í≤ΩÍ∏∞Ïàò Îß§Ìä∏Î¶≠Ïä§
    console.log('üéÆ ÏõîÎ≥Ñ Í≤ΩÍ∏∞Ïàò Îß§Ìä∏Î¶≠Ïä§');
    console.log('Ïõî\\ÌåÄ'.padEnd(10), teams.map(team => team.padEnd(6)).join(''));
    console.log('-'.repeat(10 + teams.length * 6));
    
    for (const month of months) {
        const monthName = month.substring(5);
        process.stdout.write(`${monthName}Ïõî`.padEnd(10));
        
        for (const team of teams) {
            const stats = monthlyStats[month][team];
            const totalGames = stats.wins + stats.losses + stats.ties;
            process.stdout.write(`${totalGames}Í≤ΩÍ∏∞`.padEnd(6));
        }
        console.log();
    }
    
    console.log('\n');
    
    // 4. ÏõîÎ≥Ñ ÎìùÏ†ê Îß§Ìä∏Î¶≠Ïä§
    console.log('‚öæ ÏõîÎ≥Ñ Ï¥ùÎìùÏ†ê Îß§Ìä∏Î¶≠Ïä§');
    console.log('Ïõî\\ÌåÄ'.padEnd(10), teams.map(team => team.padEnd(7)).join(''));
    console.log('-'.repeat(10 + teams.length * 7));
    
    for (const month of months) {
        const monthName = month.substring(5);
        process.stdout.write(`${monthName}Ïõî`.padEnd(10));
        
        for (const team of teams) {
            const runsFor = monthlyStats[month][team].runsFor;
            process.stdout.write(`${runsFor}Ï†ê`.padEnd(7));
        }
        console.log();
    }
    
    console.log('\n');
    
    // 5. ÏõîÎ≥Ñ ÌèâÍ∑† ÎìùÏ†ê Îß§Ìä∏Î¶≠Ïä§
    console.log('üìà ÏõîÎ≥Ñ ÌèâÍ∑†ÎìùÏ†ê Îß§Ìä∏Î¶≠Ïä§');
    console.log('Ïõî\\ÌåÄ'.padEnd(10), teams.map(team => team.padEnd(8)).join(''));
    console.log('-'.repeat(10 + teams.length * 8));
    
    for (const month of months) {
        const monthName = month.substring(5);
        process.stdout.write(`${monthName}Ïõî`.padEnd(10));
        
        for (const team of teams) {
            const stats = monthlyStats[month][team];
            const totalGames = stats.wins + stats.losses + stats.ties;
            const avgRuns = totalGames > 0 ? (stats.runsFor / totalGames).toFixed(2) : '0.00';
            process.stdout.write(`${avgRuns}`.padEnd(8));
        }
        console.log();
    }
    
    return { monthlyStats, months };
}

// ÏõîÎ≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏
function generateDetailedAnalysis(monthlyStats, months) {
    console.log('\n=== ÏõîÎ≥Ñ ÏÉÅÏÑ∏ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ ===\n');
    
    for (const month of months) {
        const monthName = `${month.substring(0, 4)}ÎÖÑ ${month.substring(5)}Ïõî`;
        console.log(`üìÖ ${monthName} Î∂ÑÏÑù`);
        console.log('-'.repeat(50));
        
        // ÏõîÎ≥Ñ ÏàúÏúÑ
        const teamPerformance = teams.map(team => {
            const stats = monthlyStats[month][team];
            const totalGames = stats.wins + stats.losses + stats.ties;
            const winRate = totalGames > 0 ? stats.wins / totalGames : 0;
            return {
                team,
                wins: stats.wins,
                losses: stats.losses,
                ties: stats.ties,
                winRate: winRate,
                runsFor: stats.runsFor,
                runsAgainst: stats.runsAgainst,
                runsDiff: stats.runsFor - stats.runsAgainst,
                totalGames
            };
        }).sort((a, b) => b.winRate - a.winRate);
        
        console.log('ÏàúÏúÑ\tÌåÄÎ™Ö\tÏäπ-Ìå®-Î¨¥\tÏäπÎ•†\tÎìùÏ†ê\tÏã§Ï†ê\tÎìùÏã§Ï∞®');
        teamPerformance.forEach((team, index) => {
            const winRateStr = (team.winRate * 100).toFixed(1) + '%';
            console.log(`${index + 1}\t${team.team}\t${team.wins}-${team.losses}-${team.ties}\t${winRateStr}\t${team.runsFor}\t${team.runsAgainst}\t${team.runsDiff > 0 ? '+' : ''}${team.runsDiff}`);
        });
        
        // ÏõîÍ∞Ñ MVP (ÏµúÍ≥† ÏäπÎ•†)
        const mvp = teamPerformance[0];
        console.log(`\nüèÜ ÏõîÍ∞Ñ MVP: ${mvp.team} (${mvp.wins}Ïäπ ${mvp.losses}Ìå®, ÏäπÎ•† ${(mvp.winRate * 100).toFixed(1)}%)`);
        
        // ÏõîÍ∞Ñ ÏµúÎã§ ÎìùÏ†êÌåÄ
        const topScorer = teamPerformance.reduce((max, team) => 
            team.runsFor > max.runsFor ? team : max
        );
        console.log(`‚öæ ÏµúÎã§ ÎìùÏ†ê: ${topScorer.team} (${topScorer.runsFor}Ï†ê)`);
        
        console.log('\n');
    }
}

// JSON ÌååÏùºÎ°ú Ï†ÄÏû•
function saveToJSON(monthlyStats, months) {
    const analysisData = {
        generatedAt: new Date().toISOString(),
        season: '2025',
        months: months,
        teams: teams,
        monthlyStats: monthlyStats,
        summary: {
            totalMonths: months.length,
            analysisComplete: true
        }
    };
    
    fs.writeFileSync('../data/monthly-analysis-complete.json', 
        JSON.stringify(analysisData, null, 2));
    
    console.log('üíæ Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ../data/monthly-analysis-complete.json ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
}

// Î©îÏù∏ Ïã§Ìñâ
function main() {
    try {
        const { monthlyStats, months } = generateMonthlyMatrix();
        generateDetailedAnalysis(monthlyStats, months);
        saveToJSON(monthlyStats, months);
        
        console.log('\n‚úÖ KBO 2025ÏãúÏ¶å ÏõîÎ≥Ñ ÏÑ±Ï†Å ÏôÑÏ†Ñ Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
        console.log(`üìä Ï¥ù ${months.length}Í∞úÏõî Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù`);
        console.log(`üèüÔ∏è ${teams.length}Í∞ú ÌåÄ Ï†ÑÏ≤¥ Ìè¨Ìï®`);
        
    } catch (error) {
        console.error('‚ùå Î∂ÑÏÑù Ï§ë Ïò§Î•ò Î∞úÏÉù:', error.message);
    }
}

if (require.main === module) {
    main();
}

module.exports = { parseGameData, generateMonthlyMatrix, generateDetailedAnalysis };